name: redevelop-build

on:
  push:
    branches: [Redevelop]
  workflow_dispatch:
    inputs:
      version:
        description: '版本号（例如 1.2.3 或 v1.2.3；留空则自动生成 dev 版本）'
        required: false
      build:
        description: '构建命令标记（build:win|build:mac|build:linux|build:all）'
        required: false

permissions:
  contents: read

jobs:
  parse:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.parse.outputs.version }}
      tag: ${{ steps.parse.outputs.tag }}
      build_script: ${{ steps.parse.outputs.build_script }}
      run_win: ${{ steps.parse.outputs.run_win }}
      run_mac: ${{ steps.parse.outputs.run_mac }}
      run_linux: ${{ steps.parse.outputs.run_linux }}
      run_unpack: ${{ steps.parse.outputs.run_unpack }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 读取提交信息
        id: msg
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            {
              echo "message<<__EOF__"
              echo "${{ github.event.inputs.version }} ${{ github.event.inputs.build }}"
              echo "__EOF__"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "message<<__EOF__"
              echo "${{ github.event.head_commit.message }}"
              echo "__EOF__"
            } >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: 解析版本与构建命令
        id: parse
        env:
          RELEASE_MESSAGE: ${{ steps.msg.outputs.message }}
        run: node scripts/ci/parse-commit.mjs

  build_win:
    needs: parse
    if: ${{ needs.parse.outputs.run_win == 'true' }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: 缓存 electron 下载
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\electron\Cache
            ~\AppData\Local\electron-builder\Cache
          key: ${{ runner.os }}-electron-cache-${{ hashFiles('pnpm-lock.yaml') }}

      - name: 确保 pnpm store 目录存在
        shell: pwsh
        run: |
          $store = (pnpm store path).Trim()
          if ($store) {
            New-Item -ItemType Directory -Force -Path $store | Out-Null
          }

      - name: 应用版本号
        run: node scripts/ci/apply-version.mjs ${{ needs.parse.outputs.version }}

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm -s typecheck

      - name: Test
        run: pnpm -s test

      - name: 构建
        run: pnpm -s build

      - name: 安装 Inno Setup
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          choco install innosetup -y --no-progress
          $iscc = (Get-Command iscc.exe -ErrorAction SilentlyContinue)?.Source
          if (-not $iscc) {
            $candidates = @(
              'C:\Program Files (x86)\Inno Setup 6\ISCC.exe',
              'C:\Program Files\Inno Setup 6\ISCC.exe'
            ) | Where-Object { Test-Path $_ }
            if ($candidates.Count -gt 0) {
              $iscc = $candidates[0]
            }
          }
          if (-not $iscc) {
            throw 'ISCC.exe not found after installing innosetup'
          }
          Add-Content -Path $env:GITHUB_PATH -Value (Split-Path $iscc)

      - name: 打包（Windows）
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          for ($i = 1; $i -le 3; $i++) {
            try {
              pnpm exec electron-builder --publish never
              break
            } catch {
              if ($i -ge 3) { throw }
              Start-Sleep -Seconds 10
            }
          }

      - name: 清理 unpacked 目录
        shell: pwsh
        run: |
          if (Test-Path dist) {
            Get-ChildItem -Path dist -Directory -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -like '*unpacked*' } |
              ForEach-Object { Remove-Item -Recurse -Force $_.FullName }
          }

      - uses: actions/upload-artifact@v4
        with:
          name: dist-win-${{ needs.parse.outputs.version }}
          path: |
            dist/*.appx
            dist/*.appxbundle
            dist/*.exe
            dist/*.blockmap
            dist/*.yml
            dist/*.yaml

  build_mac:
    needs: parse
    if: ${{ needs.parse.outputs.run_mac == 'true' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-cache-${{ hashFiles('pnpm-lock.yaml') }}

      - name: 应用版本号
        run: node scripts/ci/apply-version.mjs ${{ needs.parse.outputs.version }}

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm -s typecheck

      - name: Test
        run: pnpm -s test

      - name: 构建
        run: pnpm -s build

      - name: 打包（macOS）
        shell: bash
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            if pnpm exec electron-builder --publish never; then
              exit 0
            fi
            sleep 10
          done
          exit 1

      - name: 清理 unpacked 目录
        shell: bash
        run: |
          if [ -d dist ]; then
            find dist -maxdepth 1 -type d -name '*unpacked*' -print0 | xargs -0 -I {} rm -rf "{}"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: dist-mac-${{ needs.parse.outputs.version }}
          path: dist/**

  build_linux:
    needs: parse
    if: ${{ needs.parse.outputs.run_linux == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-cache-${{ hashFiles('pnpm-lock.yaml') }}

      - name: 应用版本号
        run: node scripts/ci/apply-version.mjs ${{ needs.parse.outputs.version }}

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm -s typecheck

      - name: Test
        run: pnpm -s test

      - name: 构建
        run: pnpm -s build

      - name: 打包（Linux）
        shell: bash
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            if pnpm exec electron-builder --publish never; then
              exit 0
            fi
            sleep 10
          done
          exit 1

      - name: 清理 unpacked 目录
        shell: bash
        run: |
          if [ -d dist ]; then
            find dist -maxdepth 1 -type d -name '*unpacked*' -print0 | xargs -0 -I {} rm -rf "{}"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: dist-linux-${{ needs.parse.outputs.version }}
          path: dist/**
