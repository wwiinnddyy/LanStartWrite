name: redevelop-build

on:
  push:
    branches: [Redevelop]
  workflow_dispatch:
    inputs:
      version:
        description: '版本号（例如 1.2.3 或 v1.2.3；留空则自动生成 dev 版本）'
        required: false
      build:
        description: '构建命令标记（build:win|build:all）'
        required: false

permissions:
  contents: read

jobs:
  parse:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.parse.outputs.version }}
      tag: ${{ steps.parse.outputs.tag }}
      build_script: ${{ steps.parse.outputs.build_script }}
      run_win: ${{ steps.parse.outputs.run_win }}
      run_mac: ${{ steps.parse.outputs.run_mac }}
      run_linux: ${{ steps.parse.outputs.run_linux }}
      run_unpack: ${{ steps.parse.outputs.run_unpack }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 读取提交信息
        id: msg
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            {
              echo "message<<__EOF__"
              echo "${{ github.event.inputs.version }} ${{ github.event.inputs.build }}"
              echo "__EOF__"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "message<<__EOF__"
              echo "${{ github.event.head_commit.message }}"
              echo "__EOF__"
            } >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: 解析版本与构建命令
        id: parse
        env:
          RELEASE_MESSAGE: ${{ steps.msg.outputs.message }}
        run: node scripts/ci/parse-commit.mjs

  build_win:
    needs: parse
    if: ${{ needs.parse.outputs.run_win == 'true' }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: 应用版本号
        run: node scripts/ci/apply-version.mjs ${{ needs.parse.outputs.version }}

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 构建
        run: pnpm -s build

      - name: 打包（Windows）
        run: pnpm exec electron-builder --publish never

      - name: 清理 unpacked 目录
        shell: pwsh
        run: |
          if (Test-Path dist) {
            Get-ChildItem -Path dist -Directory -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -like '*unpacked*' } |
              ForEach-Object { Remove-Item -Recurse -Force $_.FullName }
          }

      - uses: actions/upload-artifact@v4
        with:
          name: dist-win-${{ needs.parse.outputs.version }}
          path: dist/**
